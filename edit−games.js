/**
 *  * edit-games.js v1.0.1
  * 記録側メインロジック
   */

   const FIXED_GAS_URL = "https://script.google.com/macros/s/AKfycbx7guoxH2Vz_azvxAjcXfv7bnnez0he7UG2aBRED7AG7m4jcFyry5s-duh18kBcES5OuA/exec";

   // --- 状態管理変数 ---
   let gameId = "";
   let counts = { ball: 0, strike: 0, out: 0 };
   let runners = { base1: false, base2: false, base3: false };
   let score = { top: 0, bottom: 0 };
   let currentInning = 1;
   let isBottomInning = false;
   let isGameEnded = false;
   let historyStack = [];
   let isPushing = false;
   let syncTimer = null;
   let totalInnings = 9;

   // --- 初期化処理 ---
   document.addEventListener('DOMContentLoaded', () => {
       fetchLeagues();
           
               // 試合IDの自動生成ボタン
                   document.getElementById('gen-id-btn').addEventListener('click', () => {
                           const leagueId = document.getElementById('select-league').value || "G";
                                   const dateStr = new Date().toISOString().slice(2,10).replace(/-/g, "");
                                           const rand = Math.random().toString(36).substring(2, 5).toUpperCase();
                                                   const generated = `${leagueId}-${dateStr}-${rand}`;
                                                           const input = document.getElementById('input-game-id');
                                                                   input.value = generated;
                                                                           input.style.backgroundColor = "#fff"; // 入力可能であることを強調
                                                                               });

                                                                                   // 試合開始ボタンの処理 (全文)
                                                                                       const startBtn = document.getElementById('start-btn');
                                                                                           if (startBtn) {
                                                                                                   startBtn.addEventListener('click', async (e) => {
                                                                                                               e.preventDefault();

                                                                                                                           gameId = document.getElementById('input-game-id').value.trim();
                                                                                                                                       const leagueId = document.getElementById('select-league').value;
                                                                                                                                                   const topTeamName = document.getElementById('input-top-team').value || "先攻";
                                                                                                                                                               const bottomTeamName = document.getElementById('input-bottom-team').value || "後攻";

                                                                                                                                                                           if (!leagueId || !gameId) {
                                                                                                                                                                                           alert("リーグ選択と試合ID入力は必須です。");
                                                                                                                                                                                                           return;
                                                                                                                                                                                                                       }

                                                                                                                                                                                                                                   // 状態初期化
                                                                                                                                                                                                                                               isGameEnded = false;
                                                                                                                                                                                                                                                           counts = { ball: 0, strike: 0, out: 0 };
                                                                                                                                                                                                                                                                       runners = { base1: false, base2: false, base3: false };
                                                                                                                                                                                                                                                                                   score = { top: 0, bottom: 0 };
                                                                                                                                                                                                                                                                                               currentInning = 1;
                                                                                                                                                                                                                                                                                                           isBottomInning = false;

                                                                                                                                                                                                                                                                                                                       totalInnings = parseInt(document.getElementById('input-innings').value) || 9;
                                                                                                                                                                                                                                                                                                                                   initScoreboard(topTeamName, bottomTeamName, totalInnings);
                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                           // UI切り替え
                                                                                                                                                                                                                                                                                                                                                                       document.getElementById('display-game-id').textContent = `ID: ${gameId}`;
                                                                                                                                                                                                                                                                                                                                                                                   document.getElementById('setup-screen').classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                               document.getElementById('main-app').classList.remove('hidden');

                                                                                                                                                                                                                                                                                                                                                                                                           // ★バグ②修正：開始と同時にGASへ初回登録を行う
                                                                                                                                                                                                                                                                                                                                                                                                                       showStatus("試合を登録中...");
                                                                                                                                                                                                                                                                                                                                                                                                                                   isPushing = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                           const snapshotData = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           inning: 1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           isBottom: false,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           team: topTeamName,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           leagueName: document.getElementById('select-league').selectedOptions[0].text
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   await syncPush("試合開始", snapshotData);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   showStatus("同期完了");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               console.error(err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               showStatus("初回登録失敗");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           } finally {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           isPushing = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   // 定期的なPull（受信）を開始
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if (syncTimer) clearInterval(syncTimer); 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           syncTimer = setInterval(syncPull, 10000); 

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       // スマホキーボードを閉じる
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   document.activeElement.blur();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * GASへデータを送信 (POST)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 async function syncPush(actionName = null, logData = null) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if (!gameId) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const tableHTML = document.getElementById('scoreboard').outerHTML;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const state = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         gameId: gameId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 leagueName: document.getElementById('select-league').selectedOptions[0].text,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         topTeamName: document.getElementById('top-team-name').textContent,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 bottomTeamName: document.getElementById('bottom-team-name').textContent,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         score: score,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 counts: counts,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         runners: runners,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 currentInning: currentInning,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         isBottomInning: isBottomInning,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 isGameEnded: isGameEnded,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         tableHTML: tableHTML,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 updatedAt: new Date().toISOString()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const formData = new URLSearchParams();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             formData.append("state", JSON.stringify(state));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 if (actionName) formData.append("action", actionName);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if (logData) formData.append("logData", JSON.stringify(logData));

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const response = await fetch(FIXED_GAS_URL, {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             method: "POST",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         body: formData,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     headers: { "Content-Type": "application/x-www-form-urlencoded" }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     return await response.json();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 console.error("Push Error:", e);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         showStatus("送信エラー");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * リーグ一覧の取得
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               async function fetchLeagues() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           const res = await fetch(`${FIXED_GAS_URL}?mode=getLeagues`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   const leagues = await res.json();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           const select = document.getElementById('select-league');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   leagues.forEach(l => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               const opt = document.createElement('option');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           opt.value = l.id;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       opt.textContent = l.name;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   select.appendChild(opt);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       console.error("League Fetch Error:", e);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * スコアボードの初期化
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             function initScoreboard(top, bottom, innings) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 document.getElementById('top-team-name').textContent = top;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     document.getElementById('bottom-team-name').textContent = bottom;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const head = document.getElementById('scoreboard-head');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const bodyTop = document.getElementById('score-row-top');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const bodyBottom = document.getElementById('score-row-bottom');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             let headHtml = '<tr><th>TEAM</th>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 let topHtml = `<td>${top}</td>`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     let bottomHtml = `<td>${bottom}</td>`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             for (let i = 1; i <= innings; i++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     headHtml += `<th>${i}</th>`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             topHtml += `<td id="score-${i}-top">0</td>`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     bottomHtml += `<td id="score-${i}-bottom">0</td>`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             headHtml += '<th>R</th></tr>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 topHtml += `<td id="total-score-top">0</td>`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     bottomHtml += `<td id="total-score-bottom">0</td>`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             head.innerHTML = headHtml;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 bodyTop.innerHTML = topHtml;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     bodyBottom.innerHTML = bottomHtml;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * ステータス表示
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       function showStatus(msg) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           const el = document.getElementById('sync-status');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if (el) el.textContent = msg;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               // --- 以下、スコア更新・カウント操作・syncPull等の関数が続く ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               // (※文字数制限のため主要な修正部分を中心に構成。必要に応じて詳細関数も追加可能です)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
 */